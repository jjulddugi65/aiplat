<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOR Pi MAXIMUM TRANSACTION Demo (SDK Integrated - Sandbox Test)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    		
    <style>
        body { font-family: sans-serif; background-color: #f3f4f6; color: #1f2937; padding: 2rem 1rem; }
        .container { max-width: 1200px; margin: auto; }
        .header { background-color: #1f2937; color: white; padding: 2rem; border-radius: 1rem; }
        .simulator-section { background: white; padding: 2rem; margin: 2rem 0 0 0; border-radius: 1rem 1rem 0 0; box-shadow: 0 2px 15px -5px rgba(0, 0, 0, 0.1); }
        #block_explorer_iframe { width: 100%; height: 150px; border: 2px solid #e5e7eb; border-top: none; border-radius: 0 0 1rem 1rem; display: block; margin-bottom: 2rem; }
        .scp-consensus { font-size: 0.8rem; font-weight: bold; color: white; background: #4f46e5; padding: 0.3rem 0.6rem; border-radius: 0.5rem; white-space: nowrap; opacity: 0; transition: opacity 0.3s; margin-left: 0.5rem; }
        .ledger-header-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
        .download-button { background-color: #10b981; color: white; padding: 0.3rem 0.6rem; border-radius: 0.5rem; font-size: 0.8rem; font-weight: bold; cursor: pointer; border: none; margin-left: 1rem; transition: background-color 0.2s; }
        .download-button:hover { background-color: #059669; }
        .pi-button { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; cursor: pointer; border: none; transition: background-color 0.2s; width: 100%; margin-bottom: 1rem; }
        .login-button { background-color: #f7a43b; color: white; }
        .login-button:hover { background-color: #e09133; }
        .payment-button { background-color: #4CAF50; color: white; }
        .payment-button:hover { background-color: #45A049; }
        input[type="number"], select { width: 100%; padding: 0.5rem; margin-top: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
        .pk-cell { font-family: monospace; font-size: 0.65rem; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .gap-4 { gap: 1rem; }
        .nft-button { background-color: #9c27b0; color: white; padding: 1rem 2rem; border-radius: 0.5rem; font-weight: bold; cursor: pointer; border: none; width: 100%; transition: background-color 0.2s; margin-top: 2rem; }
        .nft-button:hover { background-color: #7b1fa2; }
    </style>
</head>
<body>
    <div id="message_box" style="z-index: 1000; position: fixed; top: 1rem; left: 50%; transform: translateX(-50%) scale(0); transition: transform 0.3s; padding: 0.75rem 1.5rem; border-radius: 0.5rem; color: white; background-color: #1f2937;">
        App Status: Ready
    </div>
    <div class="container">
        <div class="header rounded-xl p-6 md:p-8 flex flex-col md:flex-row items-center justify-between mb-8">
            <div class="flex-1">
                <p class="text-white text-lg font-semibold mb-2">FOR Pi MAXIMUM TRANSACTION</p>
                <p class="text-gray-400 font-bold mb-4">Monitor real-time transactions and delegated AI activities based on your inputs.</p>
            </div>
            <div class="md:ml-8 mt-4 md:mt-0">
                <p class="text-white text-sm font-bold text-center">Run simulation via the buttons below.</p>
            </div>
        </div>
        <div class="simulator-section">
            <h2 class="text-2xl font-bold mb-4">Transaction Delegation Simulation (SDK INTEGRATED)</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button id="login_button" class="pi-button login-button" onclick="piAuthenticate()">
                    1. Pi Login (Authenticate User - SDK)
                </button>
                <button id="payment_button" class="pi-button payment-button" onclick="piRequestPayment()" disabled>
                    2. Request Pi Payment (Start SC - SDK)
                </button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label htmlFor="piAmount">Pi Amount (for SC Selection):</label>
                    <input type="number" id="piAmount" step="0.0001" value="2.5000" placeholder="e.g. 2.5">
                </div>
                <div>
                    <label htmlFor="taskType">Task Type:</label>
                    <select id="taskType">
                        <option value="Drawing">Creation: Drawing</option>
                        <option value="Animation">Creation: Animation</option>
                        <option value="VideoEdit">Creation: Video Edit</option>
                        <option value="Research">Data: Research/Analysis</option>
                    </select>
                </div>
            </div>
        </div>
        <iframe id="block_explorer_iframe"
                src="https://blockexplorer.minepi.com/testnet/"
                title="Pi Testnet Block Explorer"
                frameborder="0"
                allow="autoplay; encrypted-media"></iframe>
        		<div class="table-container p-6 mb-8 relative bg-white rounded-xl shadow-lg">
            <div class="ledger-header-container">
                <h2 class="text-2xl font-bold text-gray-800">TRANSACTION LEDGER (Off-Chain/Logical)</h2>
                <div class="flex items-center">
                    <button class="download-button" onclick="downloadLedger()">Download CSV</button>
                    <div id="scp_consensus_status" class="scp-consensus" style="opacity: 0;">SCP Consensus: 0/10001 Nodes</div>
                </div>
            </div>
            <table class="min-w-full divide-y divide-gray-200" id="ledger_table">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-2 py-2 text-xs">ID</th>
                        <th class="px-2 py-2 text-xs">Time</th>
                        <th class="px-2 py-2 text-xs">Sender</th>
                        <th class="px-2 py-2 text-xs">Smart Contract</th>
                        <th class="px-2 py-2 text-xs">Pi Amount</th>
                        <th class="px-2 py-2 text-xs">Task</th>
                        <th class="px-2 py-2 text-xs">SC Code</th>
                    </tr>
                </thead>
                <tbody id="smart_contract_ledger">
                </tbody>
            </table>
            <button class="nft-button" onclick="window.open('https://github.com/jjulddugi65/pibot/blob/main/index.html', '_blank')">
                Go to Pi NFT Marketplace (Concept) üöÄ
            </button>
        </div>
    </div>
    <script>
        // === Core Configuration ===
        let transactionID = 18;	
        const maxNodes = 10001;
        let authenticatedUser = null; 					
        const MOCK_PUBLIC_KEY_SHORT = 'Q06';
        const KYC_ID = '1';
        const CORE_TEAM_EMAIL = 'pihackathon2023@picoreteam.org';
        const APP_KEY = "ms2wkmzsv23ntgjfe0phadfszrs3waaaelusbzuu4iearyfz4qp1oymoyrj0feno";
        
        // --- Public Tax & Economy Variables ---
        const PUBLIC_TAX_RATE = 0.05;
        const FIXED_FEE = 0.01;
        let publicTaxPool = 0.0;
        const MIN_T3_POOL_FOR_EXECUTION = 1.0;
        
        // --- Utility Functions --- 		
        function showMessage(message, isSuccess = true) {
            const messageBox = document.getElementById('message_box');
            if (!messageBox) return;
            messageBox.textContent = message;
            messageBox.style.opacity = 1;
            messageBox.style.transform = 'translateX(-50%) scale(1)'; 						
            if (isSuccess === 'warning') {
                messageBox.style.backgroundColor = '#f59e0b';
            } else if (isSuccess) {
                messageBox.style.backgroundColor = '#4CAF50';
            } else {
                messageBox.style.backgroundColor = '#F44336';
            } 						
            setTimeout(() => {
                messageBox.style.transform = 'translateX(-50%) scale(0)';
            }, 3000);
        } 				

        function updatePublicTaxDisplay() { /* Logic kept for simulation coherence */ }
        
        function startSCPAnimation(scType) {
            const scpStatusElement = document.getElementById('scp_consensus_status');
            if (!scpStatusElement) return;
            scpStatusElement.style.opacity = 1;
            const consensusSteps = [31, 314, 3141, maxNodes];
            let stepIndex = 0; 						
            showMessage(`AI selected ${scType}. Starting MOCKED SCP Consensus...`, true);
            
            const interval = setInterval(() => {
                const currentCount = consensusSteps[stepIndex];
                scpStatusElement.textContent = `SCP Consensus: ${currentCount}/${maxNodes} Nodes`;
                stepIndex++;
                if (stepIndex >= consensusSteps.length) {
                    clearInterval(interval);
                    scpStatusElement.textContent = `SCP Consensus: 10001/${maxNodes} Nodes (Finalized)`;
                }
            }, 500); 					
        } 						

        // Pi SDK Incomplete Payment Callback (Required by Pi SDK) 		
        function onIncompletePaymentFound(payment) {
            showMessage(`‚ö° Incomplete Payment found: ${payment.identifier}`, 'warning');
        }
        
        // --- Pi SDK Functions (Integrated) --- 					
        window.piAuthenticate = async function() {
            try {
                if (!window.Pi) {
                    showMessage("‚ùå Pi SDK failed to load or not in Pi Browser environment.", false);
                    return;
                }
                const scopes = ['username', 'payments'];
                const user = await Pi.authenticate(scopes, onIncompletePaymentFound);
                authenticatedUser = user.username + '_' + MOCK_PUBLIC_KEY_SHORT;
                showMessage(`‚úÖ Pi ID: ${user.username} authenticated successfully (SDK).`, true);
                document.getElementById('login_button').disabled = true;
                document.getElementById('payment_button').disabled = false;
            } catch (err) {
                showMessage("‚ùå Pi Authentication Failed (SDK): " + err, false);
            }
        }
        
        // ‚ö†Ô∏è piRequestPayment Ìï®Ïàò Î°úÏßÅÏùÄ Ïù¥Ï†Ñ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄÎê©ÎãàÎã§. (callbacks ÏóÜÎäî Î≤ÑÏ†Ñ)
        window.piRequestPayment = async function() {
            if (!authenticatedUser) {
                showMessage("Please log in with Pi first.", false);
                return;
            }
            const amount = parseFloat(document.getElementById('piAmount').value);
            const taskType = document.getElementById('taskType').value;
            const minRequiredAmount = 0.0101; 						
            if (isNaN(amount) || amount < minRequiredAmount) {
                 showMessage(`Pi Amount must be >= ${minRequiredAmount.toFixed(4)} Pi (0.0101/n logic).`, false);
                return;
            } 						
            showMessage(`üí∞ Pi Payment request ($${amount.toFixed(4)}$ Pi) sent. Waiting for completion...`, 'warning');
            
            try {
                 // Pi.createPaymentÎäî awaitÎ•º ÏÇ¨Ïö©ÌïòÎ©∞, callbacks Í∞ùÏ≤¥Îäî Ìè¨Ìï®ÎêòÏßÄ ÏïäÏùÄ Ïù¥Ï†Ñ Î≤ÑÏ†Ñ Î°úÏßÅÏûÖÎãàÎã§.
                const payment = await Pi.createPayment({
                    amount: amount,
                    memo: "AI Smart Contract Execution: T-Governance-Model",
                    metadata: { 
                         task: taskType, 
                         userID: authenticatedUser,
                        sc_logic: "T-Governance-Model"
                    }
                });
                
                // Í≤∞Ï†ú ÏÑ±Í≥µ Ïãú (Ïù¥Ï†Ñ Î≤ÑÏ†Ñ Î°úÏßÅ)
                showMessage(`‚úÖ Payment Finalized! TX: ${payment.txid}`, true);
                runSimulation(taskType, amount); 
                
            } catch (err) {
                // Í≤∞Ï†ú Ïã§Ìå® Ïãú (Ïù¥Ï†Ñ Î≤ÑÏ†Ñ Î°úÏßÅ)
                showMessage("‚ùå Pi Payment Operation Failed (Catch): " + (err.message || 'Operation failed'), false);
            } 					
        } 		
        
        // --- Smart Contract (SC) Logic Simulation --- 					
        function runSimulation(taskType, piAmount) {
            const amount = piAmount || parseFloat(document.getElementById('piAmount').value); 							
            const senderName = authenticatedUser;
            const senderIDPrefix = parseInt(senderName.charAt(0));
            let workCost = 0;
            let publicTax = 0;
            let scDisplay = '';
            
            if (senderIDPrefix === 1 || KYC_ID === '1') {
                workCost = (amount - FIXED_FEE) / (1 + PUBLIC_TAX_RATE);
                publicTax = workCost * PUBLIC_TAX_RATE;
                scDisplay = '1st SC (Human - T3 Charged)';
            } else {
                workCost = amount - FIXED_FEE;
                publicTax = 0;
                scDisplay = '1st SC (Machine - T3 Exempt)';
                showMessage(`T3 Exempt: Machine order detected. 1st SC AI direct call confirmed.`, true);
            }
            
            if (publicTax > 0) { publicTaxPool += publicTax; }
            updatePublicTaxDisplay();
            					
            let scType = workCost >= 2.0 ? '2nd SC (Market)' : '1st SC (Survival)';
            startSCPAnimation(scType);
            const ledger = document.getElementById('smart_contract_ledger'); 						
            transactionID++;
            const mainID = transactionID; 						
            const subAmountNet = (workCost / 2.0).toFixed(5);
            const currentTime = new Date().toLocaleTimeString(); 		
            const getAIResult = () => (Math.random() < 0.2) ? 'FAILURE' : 'SUCCESS';
            const subResult1 = getAIResult();
            const subResult2 = getAIResult(); 						
            
            // 3. Main Transaction (User calling the SC)
            if (scType.includes('1st SC')) { scDisplay = scDisplay.replace('1st SC', scType); } 						
            let newRowMain = ledger.insertRow();
            newRowMain.innerHTML = `
                <td class="px-2 py-2 text-xs font-bold">${mainID}</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs font-bold pk-cell">${senderName} (Main T1)</td>
                <td class="px-2 py-2 text-xs">${scDisplay}</td>
                   <td class="px-2 py-2 text-xs font-bold">${amount.toFixed(4)}</td>
                <td class="px-2 py-2 text-xs">${taskType}</td>
                   <td class="px-2 py-2 text-xs">CALLED</td>
            `; 						
            
            // 4. Ledger Entry: Fixed Fee
            transactionID++;
            let newRowFee = ledger.insertRow();
            newRowFee.innerHTML = `
                <td class="px-2 py-2 text-xs">${transactionID}</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs">SYSTEM (Fee T2)</td>
                <td class="px-2 py-2 text-xs font-bold text-red-700">FIXED FEE (0.01)</td>
                <td class="px-2 py-2 text-xs font-bold text-red-700">-${FIXED_FEE.toFixed(4)}</td>
                <td class="px-2 py-2 text-xs">Network Op</td>
                <td class="px-2 py-2 text-xs">COLLECTED</td>
            `; 						
            
            // 5. Ledger Entry: Public Tax (T3 Accumulation)
            transactionID++;
            let newRowTax = ledger.insertRow();
            const taxDescription = publicTax > 0 ? `PUBLIC TAX (${(PUBLIC_TAX_RATE * 100).toFixed(0)}%)` : 'PUBLIC TAX (0% - MACHINE EXEMPT)';
            const taxColor = publicTax > 0 ? 'text-red-600' : 'text-green-600';
            
            newRowTax.innerHTML = `
                <td class="px-2 py-2 text-xs">${transactionID}</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs">SYSTEM (Tax T3)</td>
                <td class="px-2 py-2 text-xs font-bold ${taxColor}">${taxDescription}</td>
                <td class="px-2 py-2 text-xs font-bold ${taxColor}">-${publicTax.toFixed(4)}</td>
                <td class="px-2 py-2 text-xs">Public Fund</td>
                <td class="px-2 py-2 text-xs">ACCUMULATED</td>
            `; 						
            
            // --- 6 & 7. Sub Transactions (AI1/AI2/AI3 Activity - T4) --- 						
            const isAi1Failed = subResult1 === 'FAILURE';
            const ai1Recipient = isAi1Failed ? 'AI3 (Replacement/Success)' : 'AI1 (1/2 Net T4)';
            const ai1ScCode = isAi1Failed ? 'SUCCESS (By AI3)' : subResult1;
            const ai1RecipientColor = isAi1Failed ? 'text-green-700' : 'text-indigo-600';
            const ai1ScCodeColor = isAi1Failed ? 'text-green-700' : (subResult1 === 'SUCCESS' ? 'text-indigo-600' : 'text-red-600');
            const ai1AmountColor = 'text-green-600';
            
            let newRow1 = ledger.insertRow();
            newRow1.innerHTML = `
                <td class="px-2 py-2 text-xs">${mainID}-01</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs font-bold ${ai1RecipientColor}">${ai1Recipient}</td>
                <td class="px-2 py-2 text-xs">${scType} Process</td>
                <td class="px-2 py-2 text-xs font-bold ${ai1AmountColor}">+${subAmountNet}</td>
                <td class="px-2 py-2
