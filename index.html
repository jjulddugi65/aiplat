<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FOR Pi MAXIMUM TRANSACTION Demo</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<style>
    body { font-family: sans-serif; background-color: #f3f4f6; color: #1f2937; padding: 2rem 1rem; }
    .container { max-width: 1200px; margin: auto; }
    .header { background-color: #1f2937; color: white; padding: 2rem; border-radius: 1rem; }
    .simulator-section { background: white; padding: 2rem; margin: 2rem 0 0 0; border-radius: 1rem 1rem 0 0; box-shadow: 0 2px 15px -5px rgba(0, 0, 0, 0.1); }
    #block_explorer_iframe { width: 100%; height: 150px; border: 2px solid #e5e7eb; border-top: none; border-radius: 0 0 1rem 1rem; display: block; margin-bottom: 2rem; }
    .scp-consensus { font-size: 0.8rem; font-weight: bold; color: white; background: #4f46e5; padding: 0.3rem 0.6rem; border-radius: 0.5rem; white-space: nowrap; opacity: 0; transition: opacity 0.3s; margin-left: 0.5rem; }
    .ledger-header-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
    .download-button { background-color: #10b981; color: white; padding: 0.3rem 0.6rem; border-radius: 0.5rem; font-size: 0.8rem; font-weight: bold; cursor: pointer; border: none; margin-left: 1rem; transition: background-color 0.2s; }
    .download-button:hover { background-color: #059669; }
    .pi-button { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; cursor: pointer; border: none; transition: background-color 0.2s; width: 100%; margin-bottom: 1rem; }
    .login-button { background-color: #f7a43b; color: white; }
    .login-button:hover { background-color: #e09133; }
    .payment-button { background-color: #4CAF50; color: white; }
    .payment-button:hover { background-color: #45A049; }
    input[type="number"], select { width: 100%; padding: 0.5rem; margin-top: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
    .pk-cell { font-family: monospace; font-size: 0.65rem; }
</style>
</head>
<body>
<div id="message_box" style="z-index:1000; position:fixed; top:1rem; left:50%; transform:translateX(-50%) scale(0); transition: transform 0.3s; padding:0.75rem 1.5rem; border-radius:0.5rem; color:white; background-color:#1f2937;">
    App Status: Ready
</div>

<div class="container">
    <div class="header mb-8">
        <h1 class="text-2xl font-bold">FOR Pi MAXIMUM TRANSACTION</h1>
        <p class="text-gray-400">Monitor real-time transactions (Testnet)</p>
    </div>

    <div class="simulator-section">
        <div class="grid grid-cols-2 gap-4 mb-4">
            <button id="login_button" class="pi-button login-button" disabled onclick="piAuthenticate()">1. Pi Login</button>
            <button id="payment_button" class="pi-button payment-button" disabled onclick="piRequestPayment()">2. Request Pi Payment</button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <label for="piAmount">Pi Amount:</label>
                <input id="piAmount" type="number" step="0.0001" value="2.5000">
            </div>
            <div>
                <label for="taskType">Task Type:</label>
                <select id="taskType">
                    <option value="Drawing">Drawing</option>
                    <option value="Animation">Animation</option>
                    <option value="VideoEdit">Video Edit</option>
                    <option value="Research">Research / Analysis</option>
                </select>
            </div>
        </div>
    </div>

    <iframe id="block_explorer_iframe" src="https://blockexplorer.minepi.com/testnet/" frameborder="0"></iframe>

    <div class="table-container p-6 mb-8 relative bg-white rounded-xl shadow-lg">
        <div class="ledger-header-container">
            <h2 class="text-xl font-bold">TRANSACTION LEDGER</h2>
            <div class="flex items-center">
                <button class="download-button" onclick="downloadLedger()">Download CSV</button>
                <div id="scp_consensus_status" class="scp-consensus">SCP Consensus: 0/10001 Nodes</div>
            </div>
        </div>

        <table class="min-w-full divide-y divide-gray-200" id="ledger_table">
            <thead>
                <tr class="bg-gray-50">
                    <th class="px-2 py-1 text-xs">ID</th>
                    <th class="px-2 py-1 text-xs">Time</th>
                    <th class="px-2 py-1 text-xs">Sender</th>
                    <th class="px-2 py-1 text-xs">Task</th>
                    <th class="px-2 py-1 text-xs">Pi Amount</th>
                    <th class="px-2 py-1 text-xs">Result</th>
                </tr>
            </thead>
            <tbody id="smart_contract_ledger"></tbody>
        </table>
    </div>
</div>

<script>
const APP_KEY = "ms2wkmzsv23ntgjfe0phadfszrs3waaaelusbzuu4iearyfz4qp1oymoyrj0feno";
const maxNodes = 10001;
let authenticatedUser = null;

// Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
function showMessage(msg, type="info") {
    const box = document.getElementById("message_box");
    box.textContent = msg;
    box.style.backgroundColor = type === "error" ? "#ef4444" : type === "success" ? "#22c55e" : "#1f2937";
    box.style.transform = "translateX(-50%) scale(1)";
    setTimeout(() => { box.style.transform = "translateX(-50%) scale(0)"; }, 3000);
}

// SDK Ï¥àÍ∏∞Ìôî ÌõÑ Î°úÍ∑∏Ïù∏ Î≤ÑÌäº ÌôúÏÑ±Ìôî
document.addEventListener("DOMContentLoaded", () => {
    if (!window.Pi) {
        showMessage("‚ùå Pi SDK not loaded. Please use Pi Browser.", "error");
        return;
    }
    Pi.init({
        version: "2.0",
        sandbox: true,
        appKey: APP_KEY
    });
    showMessage("‚úÖ Pi SDK initialized (Sandbox Mode)", "success");
    document.getElementById("login_button").disabled = false;
});

// Î°úÍ∑∏Ïù∏ Ìï®Ïàò
async function piAuthenticate() {
    if (!window.Pi) {
        showMessage("‚ùå Pi SDK not ready.", "error");
        return;
    }
    try {
        const user = await Pi.authenticate(["username","payments"]);
        authenticatedUser = user.username;
        showMessage(`‚úÖ Logged in as ${user.username}`, "success");
        document.getElementById("login_button").disabled = true;
        document.getElementById("payment_button").disabled = false;
    } catch (e) {
        showMessage(`‚ùå Authentication failed: ${e.message}`, "error");
    }
}

// Í≤∞Ï†ú ÏöîÏ≤≠ Ìï®Ïàò
function piRequestPayment() {
    if (!authenticatedUser) {
        showMessage("Login first.", "error");
        return;
    }
    const amount = parseFloat(document.getElementById("piAmount").value);
    const taskType = document.getElementById("taskType").value;

    Pi.createPayment({
        amount,
        memo: "AI Task: " + taskType,
        metadata: { user: authenticatedUser, task: taskType },
        callbacks: {
            onReadyForServerApproval: (paymentId) => {
                showMessage(`ü™ô Approval ready: ${paymentId}`, "success");
                runSimulation(taskType, amount);
            },
            onReadyForServerCompletion: (paymentId, txid) => {
                showMessage(`‚úÖ Payment complete (TXID: ${txid})`, "success");
            },
            onCancel: () => showMessage("‚ö†Ô∏è Payment cancelled.", "info"),
            onError: (err) => showMessage(`‚ùå Error: ${err.message}`, "error")
        }
    });
}

// Í±∞Îûò ÏãúÎÆ¨Î†àÏù¥ÏÖò Í∏∞Î°ù
function runSimulation(task, amount) {
    const ledger = document.getElementById("smart_contract_ledger");
    const row = document.createElement("tr");
    const id = Math.floor(Math.random() * 100000);
    const now = new Date().toLocaleTimeString();
    row.innerHTML = `
        <td class="px-2 py-1 text-xs">${id}</td>
        <td class="px-2 py-1 text-xs">${now}</td>
        <td class="px-2 py-1 text-xs">${authenticatedUser}</td>
        <td class="px-2 py-1 text-xs">${task}</td>
        <td class="px-2 py-1 text-xs">${amount.toFixed(4)} œÄ</td>
        <td class="px-2 py-1 text-xs text-green-600 font-bold">Pending...</td>
    `;
    ledger.prepend(row);

    // SCP ÏßÑÌñâ ÌëúÏãú
    const consensusEl = document.getElementById("scp_consensus_status");
    let progress = 0;
    consensusEl.style.opacity = 1;
    const timer = setInterval(() => {
        progress += Math.floor(Math.random()*700);
        if(progress >= maxNodes){
            consensusEl.textContent = `‚úÖ SCP Consensus: ${maxNodes}/${maxNodes} Nodes`;
            clearInterval(timer);
            row.querySelector("td:last-child").textContent = "‚úÖ AI Execution Complete";
            row.querySelector("td:last-child").classList.add("text-blue-600");
            setTimeout(()=>consensusEl.style.opacity=0,3000);
        }else{
            consensusEl.textContent = `SCP Consensus: ${progress}/${maxNodes} Nodes`;
        }
    },100);
}

// Ledger Îã§Ïö¥Î°úÎìú
function downloadLedger(){
    const table = document.getElementById('ledger_table');
    let csv=[];
    const headerRow = table.querySelector('thead tr');
    let row=[];
    headerRow.querySelectorAll('th').forEach(th=>row.push(th.innerText));
    csv.push(row.join(','));
    table.querySelectorAll('tbody tr').forEach(tr=>{
        row=[];
        tr.querySelectorAll('td').forEach(td=>row.push(td.innerText.replace(/,/g,'')));
        csv.push(row.join(','));
    });
    let csv_string = csv.join('\n');
    let filename = 'transaction_ledger_'+new Date().toISOString().slice(0,10)+'.csv';
    let link = document.createElement('a');
    link.setAttribute('href','data:text/csv;charset=utf-8,'+encodeURIComponent(csv_string));
    link.setAttribute('download',filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showMessage("‚úÖ Ledger downloaded successfully.", "success");
}
</script>
</body>
</html>
