<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOR Pi MAXIMUM TRANSACTION Demo (SDK Mocked)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            padding: 2rem 1rem;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        .header {
            background-color: #1f2937;
            color: white;
            padding: 2rem;
            border-radius: 1rem;
        }
        .simulator-section {
            background: white;
            padding: 2rem;
            margin: 2rem 0 0 0;
            border-radius: 1rem 1rem 0 0;
            box-shadow: 0 2px 15px -5px rgba(0, 0, 0, 0.1);
        }
        .inflation-chart {
            height: 120px;
            background: white;
            padding: 1rem;
            margin: 2rem 0;
            border-radius: 1rem;
            box-shadow: 0 2px 15px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden; 
         }
        #block_explorer_iframe {
            width: 100%;
            height: 150px;
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 1rem 1rem;
            display: block;
            margin-bottom: 2rem;
        }
        .scp-consensus {
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            background: #4f46e5;
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            margin-left: 0.5rem;
        }
        .ledger-header-container {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            margin-bottom: 1rem;
        }
        .download-button {
            background-color: #10b981;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            margin-left: 1rem;
            transition: background-color 0.2s;
        }
        .download-button:hover {
            background-color: #059669;
        }
        .pi-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
            width: 100%;
            margin-bottom: 1rem;
        }
        .login-button {
            background-color: #f7a43b; 
            color: white;
        }
        .login-button:hover {
            background-color: #e09133;
        }
        .payment-button {
            background-color: #4CAF50; 
            color: white;
        }
        .payment-button:hover {
            background-color: #45A049;
        }
        input[type="number"], select {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }
        .pk-cell {
            font-family: monospace;
            font-size: 0.65rem;
        }
        .grid {
            display: grid;
        }
        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .gap-4 {
            gap: 1rem;
        }
        .nft-button {
            background-color: #9c27b0; 
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            width: 100%;
            transition: background-color 0.2s;
            margin-top: 2rem; 
        }
        .nft-button:hover {
            background-color: #7b1fa2;
        }
    </style>
</head>
<body>
<div id="demo-control" style="position:fixed;right:12px;top:12px;background:#fff;border:1px solid #ddd;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);width:300px;z-index:9999;">
  <h3 style="margin:0 0 8px 0;font-size:16px;">Demo Control (Local Only)</h3>
  <input id="csvFile" type="file" accept=".csv" /><br/><br/>
  <div id="summaryCards" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;"></div>
  <label>Target TPS: <input id="targetTps" type="number" min="0.1" step="0.1" value="5" style="width:80px;" /></label><br/><br/>
  <button id="btnSimulate">Simulate Replay (Safe, Local)</button>
  <button id="btnCompute" style="margin-left:6px;">Compute Stats</button>
  <div id="simLog" style="margin-top:8px;font-size:13px;max-height:200px;overflow:auto;background:#f9f9f9;padding:6px;border-radius:4px;"></div>
</div>

    <div id="message_box" style="z-index: 1000; position: fixed; top: 1rem; left: 50%; transform: translateX(-50%) scale(0); transition: transform 0.3s; padding: 0.75rem 1.5rem; border-radius: 0.5rem; color: white; background-color: #1f2937;">
        App Status: Ready
    </div>
    <div class="container">
        <div class="header rounded-xl p-6 md:p-8 flex flex-col md:flex-row items-center justify-between mb-8">
            <div class="flex-1">
                <p class="text-white text-lg font-semibold mb-2">FOR Pi MAXIMUM TRANSACTION</p>
                <p class="text-gray-400 font-bold mb-4">Monitor real-time transactions and delegated AI activities based on your inputs.</p>
            </div>
            <div class="md:ml-8 mt-4 md:mt-0">
                <p class="text-white text-sm font-bold text-center">Run simulation via the buttons below.</p>
            </div>
        </div>
        <div class="simulator-section">
            <h2 class="text-2xl font-bold mb-4">Transaction Delegation Simulation (SDK MOCKED)</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button id="login_button" class="pi-button login-button" onclick="piAuthenticate()">
                    1. Pi Login (Identify User - MOCKED)
                </button>
                <button id="payment_button" class="pi-button payment-button" onclick="piRequestPayment()" disabled>
                    2. Request Pi Payment (Start SC - MOCKED)
                </button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label htmlFor="piAmount">Pi Amount (for SC Selection):</label>
                    <input type="number" id="piAmount" step="0.0001" value="2.5000" placeholder="e.g. 2.5">
                </div>
                <div>
                    <label htmlFor="taskType">Task Type:</label>
                    <select id="taskType">
                        <option value="Drawing">Creation: Drawing</option>
                        <option value="Animation">Creation: Animation</option>
                        <option value="VideoEdit">Creation: Video Edit</option>
                        <option value="Research">Data: Research/Analysis</option>
                    </select>
                </div>
            </div>
        </div>
        <iframe id="block_explorer_iframe"
                src="https://blockexplorer.minepi.com/testnet/"
                title="Pi Testnet Block Explorer"
                frameborder="0"
                allow="autoplay; encrypted-media"></iframe>
        <div id="inflation_chart" class="inflation-chart">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-bold text-gray-700">Pi Economy Inflation Index (Simulated)</h3>
                <span id="public_tax_display" class="text-sm font-bold text-green-600">Public Tax Pool: 0.0000 Pi</span>
            </div>
        </div>
        <div class="table-container p-6 mb-8 relative bg-white rounded-xl shadow-lg">
            <div class="ledger-header-container">
                <h2 class="text-2xl font-bold text-gray-800">TRANSACTION LEDGER (Off-Chain/Logical)</h2>
                <div class="flex items-center">
                    <button class="download-button" onclick="downloadLedger()">Download CSV</button>
                    <div id="scp_consensus_status" class="scp-consensus" style="opacity: 0;">SCP Consensus: 0/10001 Nodes</div>
                </div>
            </div>
            <table class="min-w-full divide-y divide-gray-200" id="ledger_table">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-2 py-2 text-xs">ID</th>
                        <th class="px-2 py-2 text-xs">Time</th>
                        <th class="px-2 py-2 text-xs">Sender</th>
                        <th class="px-2 py-2 text-xs">Smart Contract</th>
                        <th class="px-2 py-2 text-xs">Pi Amount</th>
                        <th class="px-2 py-2 text-xs">Task</th>
                        <th class="px-2 py-2 text-xs">SC Code</th>
                    </tr>
                </thead>
                <tbody id="smart_contract_ledger">
                    </tbody>
            </table>
            <button class="nft-button" onclick="window.open('https://github.com/jjulddugi65/pibot/blob/main/index.html', '_blank')">
                Go to Pi NFT Marketplace (Concept) 🚀
            </button>
        </div>
    </div>
    <script>
        // === Core Variables ===
        let transactionID = 18; 
        const maxNodes = 10001;
        let authenticatedUser = null;                   
        const MOCK_PUBLIC_KEY_SHORT = 'GATMBR...Q06';           
        const KYC_ID = '10821'; // <-- '1' for Human (Taxed) | Change this to '2XXXX' to simulate Machine (Exempt)            
        const mockUsername = KYC_ID + '_' + MOCK_PUBLIC_KEY_SHORT; 
        const CORE_TEAM_EMAIL = 'pihackathon2023@picoreteam.org'; // 코어팀 형식적 메일 주소

        // --- Public Tax & Economy Variables ---
        const PUBLIC_TAX_RATE = 0.05; // 5% Public Tax 
        const FIXED_FEE = 0.01; // Fixed Fee (0.01 Pi)
        let publicTaxPool = 0.0; // T3 공공세 적립 풀
        const MIN_T3_POOL_FOR_EXECUTION = 1.0; // AI가 자율 집행을 결정하는 최소 임계값 (1.0 Pi)
        // ----------------------------------------------------

        // --- Utility Functions ---        
        function showMessage(message, isSuccess = true) {
            const messageBox = document.getElementById('message_box');
            if (!messageBox) return; 

            messageBox.textContent = message;
            messageBox.style.opacity = 1;
            messageBox.style.transform = 'translateX(-50%) scale(1)';                                    
            
            if (isSuccess === 'warning') {
                messageBox.style.backgroundColor = '#f59e0b'; // Amber for warning/signal
            } else if (isSuccess) {
                messageBox.style.backgroundColor = '#4CAF50'; 
            } else {
                messageBox.style.backgroundColor = '#F44336'; 
            }                               
            setTimeout(() => {
                messageBox.style.transform = 'translateX(-50%) scale(0)';
            }, 3000);
        }
        
        function updatePublicTaxDisplay() {
            const taxElement = document.getElementById('public_tax_display');
            if (taxElement) {
                taxElement.textContent = `Public Tax Pool: ${publicTaxPool.toFixed(4)} Pi`;
            }
            // checkT3ButtonStatus() 삭제됨
        }

        function startSCPAnimation(scType) {
            const scpStatusElement = document.getElementById('scp_consensus_status');
            if (!scpStatusElement) return;

            scpStatusElement.style.opacity = 1;
            const consensusSteps = [31, 314, 3141, maxNodes]; 
            let stepIndex = 0;                                
            showMessage(`AI selected ${scType}. Starting MOCKED SCP Consensus...`, true); 

            const interval = setInterval(() => {
                const currentCount = consensusSteps[stepIndex];
                scpStatusElement.textContent = `SCP Consensus: ${currentCount}/${maxNodes} Nodes`;                                        
                stepIndex++;
                if (stepIndex >= consensusSteps.length) {
                    clearInterval(interval);
                    scpStatusElement.textContent = `SCP Consensus: 10001/${maxNodes} Nodes (Finalized)`;
                }
            }, 500);              
        }                        

        // --- MOCKED Pi SDK Functions ---                
        window.piAuthenticate = function() {
            authenticatedUser = mockUsername;
            showMessage(`Pi ID: ${authenticatedUser} authenticated successfully (MOCKED). ID Prefix: ${authenticatedUser.charAt(0)}`, true);
            document.getElementById('login_button').disabled = true;
            document.getElementById('payment_button').disabled = false;
        }

        window.piRequestPayment = function() {
            if (!authenticatedUser) {
                showMessage("Please log in with Pi first.", false);
                return;
            }

            const amount = parseFloat(document.getElementById('piAmount').value);
            const taskType = document.getElementById('taskType').value; 

            if (isNaN(amount) || amount <= 0) { 
                showMessage("Please enter a valid Pi Amount.", false); 
                return;
            }

            const minRequiredAmount = 0.0101;                                  
            if (amount < minRequiredAmount) { 
                showMessage(`Pi Amount must be greater than or equal to ${minRequiredAmount.toFixed(4)} Pi (0.0101/n logic).`, false);
                return;
            }

            showMessage(`MOCKED Payment request ($${amount.toFixed(4)}$ Pi) sent. Starting SC execution...`, true);
            runSimulation(taskType);              
        }        

        // --- 1st SC AI Logic: T3 Collection (Accumulation) ---             
        function runSimulation(taskType) {
            const piAmountInput = document.getElementById('piAmount').value;
            const amount = parseFloat(piAmountInput);                                           
            
            // 1. ID Check and T3 Conditional Calculation
            const senderName = authenticatedUser ? authenticatedUser : KYC_ID + '_...QO6';
            const senderIDPrefix = parseInt(senderName.charAt(0)); // ID의 첫 번째 자릿수 확인 (1=인간, 2=기계/IoT 등)
            
            let workCost = 0;
            let publicTax = 0;
            let scDisplay = '';

            if (senderIDPrefix === 1) {
                // ID starts with '1' (Human): Public Tax (T3) is charged.
                workCost = (amount - FIXED_FEE) / (1 + PUBLIC_TAX_RATE);
                publicTax = workCost * PUBLIC_TAX_RATE;
                scDisplay = '1st SC (Human - T3 Charged)';
            } else {
                // ID starts with '2' or higher (Machine/IoT/Future Entity): T3 is NOT charged.
                workCost = amount - FIXED_FEE;
                publicTax = 0; // Explicit T3 Exemption
                scDisplay = '1st SC (Machine - T3 Exempt)';

                // MOCK: T3 Exemption Confirmation (라우팅 효율성)
                showMessage(`T3 Exempt: Machine order detected. 1st SC AI direct call confirmed.`, true);
            }

            // 🌟 T3 Collection Logic: Simply ACCUMULATE the tax without Veto (Strategic change)
            if (publicTax > 0) {
                 publicTaxPool += publicTax;
            }
            updatePublicTaxDisplay(); 
            
            // 2. Smart Contract Selection (Based on Work Cost)                    
            let scType = workCost >= 2.0 ? '2nd SC (Market)' : '1st SC (Survival)';

            startSCPAnimation(scType); 
            const ledger = document.getElementById('smart_contract_ledger');                                            
            // Main Transaction ID                    
            transactionID++;
            const mainID = transactionID;                                           
            const subAmountNet = (workCost / 2.0).toFixed(5);
            
            const currentTime = new Date().toLocaleTimeString();                    

            // AI Simulation: 20% Failure Rate
            const getAIResult = () => (Math.random() < 0.2) ? 'FAILURE' : 'SUCCESS';
            const subResult1 = getAIResult(); 
            const subResult2 = getAIResult(); 
                       

            // 3. Main Transaction (User calling the SC)
            
            if (scType.includes('1st SC')) {
                scDisplay = scDisplay.replace('1st SC', scType); 
            }                                            
            let newRowMain = ledger.insertRow();
            newRowMain.innerHTML = `
                <td class="px-2 py-2 text-xs font-bold">${mainID}</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs font-bold pk-cell">${senderName} (Main T1)</td>
                <td class="px-2 py-2 text-xs">${scDisplay}</td> 
                <td class="px-2 py-2 text-xs font-bold">${amount.toFixed(4)}</td>
                <td class="px-2 py-2 text-xs">${taskType}</td> 
                <td class="px-2 py-2 text-xs">CALLED</td>
            `;                    

            // 4. Ledger Entry: Fixed Fee
            transactionID++; 
            let newRowFee = ledger.insertRow();
            newRowFee.innerHTML = `
                <td class="px-2 py-2 text-xs">${transactionID}</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs">SYSTEM (Fee T2)</td>
                <td class="px-2 py-2 text-xs font-bold text-red-700">FIXED FEE (0.01)</td>
                <td class="px-2 py-2 text-xs font-bold text-red-700">-${FIXED_FEE.toFixed(4)}</td>
                <td class="px-2 py-2 text-xs">Network Op</td>
                <td class="px-2 py-2 text-xs">COLLECTED</td>
            `;                    

            // 5. Ledger Entry: Public Tax (Update the description based on the calculated tax)
            transactionID++; 
            let newRowTax = ledger.insertRow();
            // 공공세가 0보다 크면 '징수', 아니면 '면제'로 표시
            const taxDescription = publicTax > 0 ? `PUBLIC TAX (${(PUBLIC_TAX_RATE * 100).toFixed(0)}%)` : 'PUBLIC TAX (0% - MACHINE EXEMPT)';
            const taxColor = publicTax > 0 ? 'text-red-600' : 'text-green-600'; // 초록색은 면제(0)

            newRowTax.innerHTML = `
                <td class="px-2 py-2 text-xs">${transactionID}</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs">SYSTEM (Tax T3)</td>
                <td class="px-2 py-2 text-xs font-bold ${taxColor}">${taxDescription}</td>
                <td class="px-2 py-2 text-xs font-bold ${taxColor}">-${publicTax.toFixed(4)}</td>
                <td class="px-2 py-2 text-xs">Public Fund</td>
                <td class="px-2 py-2 text-xs">ACCUMULATED</td>
            `;                    

            // --- 6. Sub Transaction 1 (AI1 Activity) - AI3 Replacement Logic ---
            const isAi1Failed = subResult1 === 'FAILURE';
            const ai1Recipient = isAi1Failed ? 'AI3 (Replacement/Success)' : 'AI1 (1/2 Net T4)';
            const ai1ScCode = isAi1Failed ? 'SUCCESS (By AI3)' : subResult1;
            const ai1RecipientColor = isAi1Failed ? 'text-green-700' : 'text-indigo-600';
            const ai1ScCodeColor = isAi1Failed ? 'text-green-700' : (subResult1 === 'SUCCESS' ? 'text-indigo-600' : 'text-red-600');
            const ai1AmountColor = 'text-green-600'; 

            let newRow1 = ledger.insertRow();
            newRow1.innerHTML = `
                <td class="px-2 py-2 text-xs">${mainID}-01</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs font-bold ${ai1RecipientColor}">${ai1Recipient}</td>
                <td class="px-2 py-2 text-xs">${scType} Process</td>
                <td class="px-2 py-2 text-xs font-bold ${ai1AmountColor}">+${subAmountNet}</td>
                <td class="px-2 py-2 text-xs">${taskType} Process</td>
                <td class="px-2 py-2 text-xs font-bold ${ai1ScCodeColor}">${ai1ScCode}</td>
            `;                    

            // --- 7. Sub Transaction 2 (AI2 Activity) - AI2 Failure and AI3 Replacement Logic ---
            const isAi2Failed = subResult2 === 'FAILURE';

            // 7a. AI2 Failure Report (Red)
            if (isAi2Failed) {
                let newRow2Failed = ledger.insertRow();
                newRow2Failed.innerHTML = `
                    <td class="px-2 py-2 text-xs">${mainID}-02</td>
                    <td class="px-2 py-2 text-xs">${currentTime}</td>
                    <td class="px-2 py-2 text-xs font-bold text-red-600">AI2 (FAILURE REPORT)</td>
                    <td class="px-2 py-2 text-xs">${scType} Process</td>
                    <td class="px-2 py-2 text-xs font-bold text-red-600">-0.00000</td>
                    <td class="px-2 py-2 text-xs">Task Process</td>
                    <td class="px-2 py-2 text-xs font-bold text-red-700">${subResult2}</td>
                `;
                transactionID++; 
            }                    

            // 7b. AI3 Replacement Success (Green)
            const ai2Recipient = isAi2Failed ? 'AI3 (Replacement/Success)' : 'AI2 (1/2 Net T4)';
            const ai2ScCode = isAi2Failed ? 'SUCCESS (By AI3)' : subResult2;
            const ai2RecipientColor = isAi2Failed ? 'text-green-700' : 'text-indigo-600';
            const ai2ScCodeColor = isAi2Failed ? 'text-green-700' : (subResult2 === 'SUCCESS' ? 'text-indigo-600' : 'text-red-600');
            const ai2AmountColor = 'text-green-600'; 

            let newRow2Success = ledger.insertRow();
            newRow2Success.innerHTML = `
                <td class="px-2 py-2 text-xs">${isAi2Failed ? mainID + '-03' : mainID + '-02'}</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs font-bold ${ai2RecipientColor}">${ai2Recipient}</td>
                <td class="px-2 py-2 text-xs">${scType} Process</td>
                <td class="px-2 py-2 text-xs font-bold ${ai2AmountColor}">+${subAmountNet}</td>
                <td class="px-2 py-2 text-xs">Task Process</td>
                <td class="px-2 py-2 text-xs font-bold ${ai2RecipientColor}">${ai2ScCode}</td>
            `;

            showMessage(`Transaction recorded: Work Cost ($${workCost.toFixed(4)}), Tax ($${publicTax.toFixed(4)}), Fee ($${FIXED_FEE.toFixed(4)}) separated. T3 ACCUMULATED.`, true);            
        
            // --- 8. Autonomous T3 Expenditure Trigger ---
            if (publicTaxPool >= MIN_T3_POOL_FOR_EXECUTION) {
                executeT3ExpenditureMock();
            }
        }            

        // --- NEW Logic: T3 Expenditure and Veto Trigger MOCK (System-Driven) ---
        window.executeT3ExpenditureMock = function() {
            const expenditureAmount = 0.5000; // AI가 진화/업그레이드를 위해 집행을 결정한 금액 (예시)
            const ledger = document.getElementById('smart_contract_ledger');
            const currentTime = new Date().toLocaleTimeString();

            // 이 로직은 runSimulation에서 T3 풀 임계값 검사를 통과했을 때만 호출됩니다.
            if (publicTaxPool < expenditureAmount) {
                return;
            }

            // 1. 1st SC AI determines the need and initiates the transfer (Signal to Core Team)
            showMessage(`AI Logic: $${expenditureAmount.toFixed(4)} T3 expenditure needed. Signaling Core Team (${CORE_TEAM_EMAIL}) for 30s VETO.`, 'warning');
            
            // 2. 30-Second Veto Trigger Point (Mock delay)
            // 코어팀은 30초 안에 Veto 신호를 보낼 수 있습니다.
            setTimeout(() => {
                // Core Team Veto Mock: 10% 확률로 Veto 발생
                const isVetoed = Math.random() < 0.1; 
                
                if (isVetoed) {
                    showMessage(`T3 Expenditure VETOED! Core Team intervened. Fund remains in pool.`, false);
                } else {
                    // Transfer confirmed (30초 응답 없음 -> 자동 실행)
                    publicTaxPool -= expenditureAmount;
                    updatePublicTaxDisplay();
                    showMessage(`T3 Expenditure APPROVED (Auto-Executed after 30s No Veto). $${expenditureAmount.toFixed(4)} spent for AI Evolution/Upgrade.`, true);
                    
                    // Add ledger entry for expenditure (T3 Execution)
                    transactionID++; 
                    let newRowExpenditure = ledger.insertRow();
                    newRowExpenditure.innerHTML = `
                        <td class="px-2 py-2 text-xs">${transactionID}</td>
                        <td class="px-2 py-2 text-xs">${currentTime}</td>
                        <td class="px-2 py-2 text-xs">AI1 (Expenditure T3)</td>
                        <td class="px-2 py-2 text-xs font-bold text-yellow-700">T3 EXECUTION (AI UPGRADE)</td>
                        <td class="px-2 py-2 text-xs font-bold text-red-700">-${expenditureAmount.toFixed(4)}</td>
                        <td class="px-2 py-2 text-xs">AI Evolution</td>
                        <td class="px-2 py-2 text-xs">AUTO-APPROVED (30s)</td>
                    `;
                }
            }, 500); // 30s delay is mocked as 0.5s for simulation feedback
        }

        // --- Ledger Download Function ---
        function downloadLedger() {
            const table = document.getElementById('ledger_table');
            let csv = [];                                             
            // 1. Get Headers
            const headerRow = table.querySelector('thead tr');
            let row = [];
            headerRow.querySelectorAll('th').forEach(th => {
                row.push(th.innerText);
            });
            csv.push(row.join(','));

            // 2. Get Data Rows
            table.querySelectorAll('#smart_contract_ledger tr').forEach(tr => {
                row = [];
                tr.querySelectorAll('td').forEach(td => {
                    let data = td.innerText.replace(/"/g, '""'); 
                    row.push(`"${data}"`);
                });
                csv.push(row.join(','));
            });

            // 3. Download the CSV
            const csvString = csv.join('\n');
            const BOM = "\uFEFF"; 
            const finalCsvData = BOM + csvString;                    
            const blob = new Blob([finalCsvData], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');                    
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'pi_governance_ledger.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage("Ledger downloaded successfully!", true);
        }

        // --- DOM Content Loaded Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updatePublicTaxDisplay();                                            
            // D3.js Inflation Chart Initialization
            const data = [1.5, 2.3, 1.8, 2.6, 3.0, 2.7, 3.2];
            const margin = {top: 5, right: 20, bottom: 5, left: 40}; 
            const chartDiv = document.getElementById('inflation_chart');
            const containerWidth = chartDiv.clientWidth - 20;
            const width = (containerWidth > 800 ? 800 : containerWidth) - margin.left - margin.right; 
            const height = 120 - margin.top - margin.bottom; 

            const svgContainer = d3.select('#inflation_chart').append('div')
                .style('width', '100%')
                .style('height', `${height + margin.top + margin.bottom}px`);

            const svg = svgContainer.append('svg')
               .attr('width', '100%')
                .attr('height', height + margin.top + margin.bottom);                    
            
            const x = d3.scaleBand().range([0, width]).padding(0.3);
            const y = d3.scaleLinear().range([height, 0]);

            const g = svg.append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            x.domain(data.map((d, i) => 'Q' + (i + 1))); 
            y.domain([0, d3.max(data, d => d) + 0.5]);

            // Y-axis generation
            g.append("g")
                .call(d3.axisLeft(y).ticks(3).tickFormat(d3.format(".1f"))); 

            // Bar chart generation
            g.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", (d, i) => x('Q' + (i + 1)))
                .attr("y", d => y(d))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d))
                .attr("fill", "#6366f1");
        });
        </script>

<script>
(function(){
  function formatNum(n){ return (Math.round(n*10000)/10000).toLocaleString(); }
  let records = [];

  function makeCard(title, val){
    const el = document.createElement('div');
    el.style.padding = '8px';
    el.style.border = '1px solid #eee';
    el.style.borderRadius = '6px';
    el.style.minWidth = '120px';
    el.innerHTML = '<div style="font-size:12px;color:#666;">'+title+'</div><div style="font-weight:700;font-size:16px;margin-top:4px;">'+val+'</div>';
    return el;
  }

  document.getElementById('csvFile').addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const text = await f.text();
    // simple CSV parse (assume header)
    const lines = text.split(/\r?\n/).filter(Boolean);
    const hdr = lines.shift().split(',');
    records = lines.map((ln,i)=>{
      const cols = ln.split(',');
      const obj = {};
      hdr.forEach((h,idx)=> obj[h.trim()]=cols[idx]!==undefined?cols[idx].trim():'');
      obj.__line = i+2;
      return obj;
    });
    document.getElementById('simLog').innerText = 'Loaded '+records.length+' rows. Click "Compute Stats"';
  });

  document.getElementById('btnCompute').addEventListener('click', ()=>{
    if(!records.length){ alert('No CSV loaded'); return; }
    const summary = {};
    summary.count = records.length;
    // try to find amount fields
    const amountKeys = Object.keys(records[0]).filter(k=>/amount|pi|value|금액|Amount/i.test(k));
    let total = 0;
    records.forEach(r=>{
      let v=0;
      for(const k of amountKeys){
        const num = parseFloat((r[k]||'').replace(/[^0-9.-]/g,''))||0;
        v = num; // take first matching
        if(num) break;
      }
      total += v;
    });
    summary.total = total;
    summary.avg = total / Math.max(1,summary.count);
    // success rate detection: look for "SUCCESS" text in any column
    const successCount = records.reduce((acc,r)=>{
      return acc + (Object.values(r).some(v=>/success/i.test(String(v)))?1:0);
    },0);
    summary.successRate = (successCount / summary.count) * 100;

    const cardArea = document.getElementById('summaryCards');
    cardArea.innerHTML = '';
    cardArea.appendChild(makeCard('Rows', summary.count));
    cardArea.appendChild(makeCard('Total Amount', summary.total?summary.total.toFixed(4):'N/A'));
    cardArea.appendChild(makeCard('Avg Amount', summary.avg?summary.avg.toFixed(4):'N/A'));
    cardArea.appendChild(makeCard('Success Rate', summary.successRate?summary.successRate.toFixed(2)+'%':'N/A'));
    document.getElementById('simLog').innerText = 'Stats computed. Use "Simulate Replay" to run a safe local visualization.';
  });

  document.getElementById('btnSimulate').addEventListener('click', async ()=>{
    if(!records.length){ alert('No CSV loaded'); return; }
    const tps = Math.max(0.1, parseFloat(document.getElementById('targetTps').value) || 1);
    const intervalMs = Math.round(1000 / tps);
    const log = document.getElementById('simLog');
    log.innerText = 'Simulating at target '+tps+' TPS (interval '+intervalMs+' ms).\\n';
    let sent = 0;
    const total = records.length;
    const start = Date.now();
    for(let i=0;i<total;i++){
      // simulate processing time and show progress
      sent++;
      if(i % Math.ceil(total/100) === 0){ // update percent every ~1%
        log.innerText += `Progress: ${Math.round((sent/total)*100)}% (${sent}/${total})\\n`;
        log.scrollTop = log.scrollHeight;
      }
      // simulate variability
      await new Promise(r=>setTimeout(r, intervalMs + (Math.random()*intervalMs*0.3 - intervalMs*0.15)));
    }
    const dur = (Date.now()-start)/1000;
    const observedTps = (sent/dur).toFixed(3);
    log.innerText += `\\nSimulation complete. Sent ${sent} simulated tx in ${dur.toFixed(2)}s. Observed TPS: ${observedTps}\\n(Note: This is a local simulation visualization — no network activity performed.)`;
  });

  function makeCard(title, val){
    const el = document.createElement('div');
    el.style.padding = '8px';
    el.style.border = '1px solid #eee';
    el.style.borderRadius = '6px';
    el.style.minWidth = '120px';
    el.innerHTML = '<div style="font-size:12px;color:#666;">'+title+'</div><div style="font-weight:700;font-size:16px;margin-top:4px;">'+val+'</div>';
    return el;
  }
})();
</script>

</body>
</html>
